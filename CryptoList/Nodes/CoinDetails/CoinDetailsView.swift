//
//  CoinDetailsView.swift
//  CryptoList
//
//  Created by Maksim Bezdrobnoi on 21.10.2023.
//

import SwiftUI

public struct CoinDetailsView<ViewModel: CoinDetailsViewModelProtocol>: View {

    @ObservedObject private var viewModel: ViewModel
    private let customAsyncImageRenderer: CustomAsyncImageRenderer

    public init(viewModel: ViewModel,customAsyncImageRenderer: CustomAsyncImageRenderer) {
        self.viewModel = viewModel
        self.customAsyncImageRenderer = customAsyncImageRenderer
    }

    public var body: some View {
        ScrollView(.vertical) {
            VStack {
                makeHeader()
                CoinAdditionalInformationView(coin: viewModel.coin)
                CoinExtendedCharView(coin: viewModel.coin)
                    .frame(height: 400)
            }
            .padding(.horizontal, 16)
        }
    }

    @ViewBuilder private func makeHeader() -> some View {
        VStack(alignment: .leading) {
            HStack {
                customAsyncImageRenderer.renderImage(
                    by: viewModel.coin.name,
                    for: URL(string: viewModel.coin.iconUrl ?? ""),
                    content: { $0.resizable() },
                    placeholder: { Image(systemName: "face.dashed") }
                )
                .frame(width: 25, height: 25)

                Text(viewModel.coin.name)
                    .font(.headline)

                Text(viewModel.coin.symbol.uppercased())
                    .font(.headline)
                    .foregroundColor(.secondary)
            }

            HStack {
                Text(viewModel.coin.price.toMonetaryString(currency: viewModel.coin.currency))
                    .font(.largeTitle)
                    .bold()

                tradeChange(for: viewModel.coin.hourTradeChange)
                    .bold()
            }
        }
        .frame(maxWidth: .infinity, alignment: .leading)
    }

    @ViewBuilder private func tradeChange(for percent: Double?) -> some View {
        if let percent {
            if percent > 0 {
                HStack {
                    Image(systemName: "arrowshape.up.fill")
                        .frame(width: 10, height: 10)
                    Text("\(percent, specifier: "%.2f")%")
                }
                .foregroundColor(.green)
            } else {
                HStack {
                    Image(systemName: "arrowshape.down.fill")
                        .frame(width: 10, height: 10)
                    Text("\(percent, specifier: "%.2f")%")
                }
                    .foregroundColor(.red)
            }
        } else {
            Text("-")
        }
    }
}

//#Preview {
//    CoinDetailsView(viewModel: CoinDetailsViewModel(coin: .mock))
//}

public extension Coin {

    static let mock = Coin(
        currency: "USD",
        iconUrl: "https://assets.coingecko.com/coins/images/1/large/bitcoin.png?1547033579",
        name: "Bitcoin",
        symbol: "BTC",
        price: 3000.23,
        hourTradeChange: 1.4,
        dayTradeChange: 5.5,
        weekTradeChange: 6.2,
        marketCap: 567999999999.0,
        dayVolume: 6888888888.0,
        circulatingSupply: 19555555,
        totalSupply: 21000000,
        maxSupply: 21000000,
        dayGraph: [
            [
              1697813716181,
              27940.517781983162
            ],
            [
              1697814004040,
              27946.292648513114
            ],
            [
              1697814299369,
              27895.516321601495
            ],
            [
              1697814606881,
              27920.96730789869
            ],
            [
              1697814903990,
              27931.012864080814
            ],
            [
              1697815198867,
              27927.18557695062
            ],
            [
              1697815507303,
              27898.67879436091
            ],
            [
              1697815805483,
              27942.631048702387
            ],
            [
              1697816104574,
              27878.31531583141
            ],
            [
              1697816400901,
              27908.5284611092
            ],
            [
              1697816701168,
              27874.364665310808
            ],
            [
              1697817000586,
              27862.25617346931
            ],
            [
              1697817301076,
              27895.17594584082
            ],
            [
              1697817599603,
              27894.49678801686
            ],
            [
              1697817904332,
              27862.014902980023
            ],
            [
              1697818203004,
              27876.421309569017
            ],
            [
              1697818500309,
              27860.021740217864
            ],
            [
              1697818799316,
              27854.03673219336
            ],
            [
              1697819100407,
              27915.432047131926
            ],
            [
              1697819397986,
              27923.230639977482
            ],
            [
              1697819694985,
              27930.72316583015
            ],
            [
              1697820002395,
              27923.27285557653
            ],
            [
              1697820301481,
              27916.86701582858
            ],
            [
              1697820600318,
              27895.416533521657
            ],
            [
              1697820909212,
              27876.808822581843
            ],
            [
              1697821206213,
              27863.441128515537
            ],
            [
              1697821515379,
              27835.671928281772
            ],
            [
              1697821802654,
              27792.392118766413
            ],
            [
              1697822110471,
              27764.459197261323
            ],
            [
              1697822409015,
              27805.51520230079
            ],
            [
              1697822696846,
              27796.994712306838
            ],
            [
              1697823000750,
              27802.706610459947
            ],
            [
              1697823321532,
              27820.233527883298
            ],
            [
              1697823599887,
              27807.9583250584
            ],
            [
              1697823909752,
              27841.984434440008
            ],
            [
              1697824218144,
              27842.454566928838
            ],
            [
              1697824498777,
              27858.435142278246
            ],
            [
              1697824819577,
              27863.575775750258
            ],
            [
              1697825120387,
              27870.69259994476
            ],
            [
              1697825419622,
              27882.38568459764
            ],
            [
              1697825718653,
              27833.34253662846
            ],
            [
              1697826037516,
              27847.167009653844
            ],
            [
              1697826325167,
              27862.978902782852
            ],
            [
              1697826590903,
              27870.473457514487
            ],
            [
              1697826900975,
              27872.551855955608
            ],
            [
              1697827197707,
              27879.579656392118
            ],
            [
              1697827517077,
              27861.64418146498
            ],
            [
              1697827835920,
              27860.89074271929
            ],
            [
              1697828114034,
              27854.901592441034
            ],
            [
              1697828414311,
              27836.356503039857
            ],
            [
              1697828692054,
              27844.54475887681
            ],
            [
              1697828999142,
              27860.364437286116
            ],
            [
              1697829319443,
              27858.93237706264
            ],
            [
              1697829649634,
              27810.659439769173
            ],
            [
              1697829930530,
              27786.696109039785
            ],
            [
              1697830220352,
              27789.284569592764
            ],
            [
              1697830519891,
              27794.714528397442
            ],
            [
              1697830806981,
              27822.093732541744
            ],
            [
              1697831096305,
              27785.214053516444
            ],
            [
              1697831404353,
              27835.804971830035
            ],
            [
              1697831705497,
              27882.73451425799
            ],
            [
              1697832007177,
              27910.17290379619
            ],
            [
              1697832317365,
              27891.675934098224
            ],
            [
              1697832628015,
              27922.978270524916
            ],
            [
              1697832894259,
              27925.260192458016
            ],
            [
              1697833193058,
              27919.65910543561
            ],
            [
              1697833513787,
              27958.616155160315
            ],
            [
              1697833824255,
              27915.801287695387
            ],
            [
              1697834112196,
              27928.8982704425
            ],
            [
              1697834416744,
              27944.811014212788
            ],
            [
              1697834716101,
              27989.777685159166
            ],
            [
              1697835026211,
              27957.209850971245
            ],
            [
              1697835316851,
              27957.04983396653
            ],
            [
              1697835660458,
              27930.573184106168
            ],
            [
              1697835927169,
              27942.84364635504
            ],
            [
              1697836245718,
              27953.06742175883
            ],
            [
              1697836513595,
              27966.267414794595
            ],
            [
              1697836843582,
              27951.955627660333
            ],
            [
              1697837123897,
              27972.595163067184
            ],
            [
              1697837439776,
              27960.745592956097
            ],
            [
              1697837716642,
              27966.61135341551
            ],
            [
              1697838018274,
              27970.53391368515
            ],
            [
              1697838306975,
              27951.38597742015
            ],
            [
              1697838615893,
              27972.564663562523
            ],
            [
              1697838925581,
              27963.904682675296
            ],
            [
              1697839214191,
              27948.447980480334
            ],
            [
              1697839508770,
              27951.27081485155
            ],
            [
              1697839829469,
              27967.221192258745
            ],
            [
              1697840120613,
              27976.077767248735
            ],
            [
              1697840436789,
              27967.172903352766
            ],
            [
              1697840717390,
              27945.714399604927
            ],
            [
              1697841017793,
              27965.023124655483
            ],
            [
              1697841323094,
              27980.34060765714
            ],
            [
              1697841651722,
              27968.551978989373
            ],
            [
              1697841917075,
              27959.707799665022
            ],
            [
              1697842195913,
              27965.456784026912
            ],
            [
              1697842494717,
              27982.07177809515
            ],
            [
              1697842802566,
              27972.184966329154
            ],
            [
              1697843101980,
              28041.040394134896
            ],
            [
              1697843399141,
              28060.533199997713
            ],
            [
              1697843716990,
              28073.40548399874
            ],
            [
              1697844046009,
              28059.482515006282
            ],
            [
              1697844322650,
              28056.586888506827
            ],
            [
              1697844598486,
              28068.469993871655
            ],
            [
              1697844909614,
              28030.916921083408
            ],
            [
              1697845208579,
              28022.679761104642
            ],
            [
              1697845497229,
              28011.430362556064
            ],
            [
              1697845837447,
              28016.91182371358
            ],
            [
              1697846125644,
              28002.104059921723
            ],
            [
              1697846402666,
              28001.62728736506
            ],
            [
              1697846700911,
              27995.082441187864
            ],
            [
              1697846998531,
              28025.98494366281
            ],
            [
              1697847298469,
              28012.344522014715
            ],
            [
              1697847606942,
              28014.802787669705
            ],
            [
              1697847902716,
              28000.209952680987
            ],
            [
              1697848212429,
              28031.43368755143
            ],
            [
              1697848507415,
              27999.41103864119
            ],
            [
              1697848804500,
              27989.739782834196
            ],
            [
              1697849102831,
              27971.349928930125
            ],
            [
              1697849400815,
              27933.210142718613
            ],
            [
              1697849698750,
              27946.54394339297
            ],
            [
              1697849995631,
              27970.297439891594
            ],
            [
              1697850299314,
              27975.13053439821
            ],
            [
              1697850598134,
              27958.334965095728
            ],
            [
              1697850897885,
              27964.90241944542
            ],
            [
              1697851205912,
              27961.44144562376
            ],
            [
              1697851495007,
              27944.121501058864
            ],
            [
              1697851806880,
              27937.840334700486
            ],
            [
              1697852100566,
              27935.29128781353
            ],
            [
              1697852423068,
              27907.20363725329
            ],
            [
              1697852722776,
              27902.1580180994
            ],
            [
              1697853030934,
              27900.51114859695
            ],
            [
              1697853329213,
              27896.641441630094
            ],
            [
              1697853677002,
              27856.49496865036
            ],
            [
              1697853927702,
              27851.83948254677
            ],
            [
              1697854225688,
              27865.863594281327
            ],
            [
              1697854524684,
              27881.45754560323
            ],
            [
              1697854822807,
              27878.508705977347
            ],
            [
              1697855121425,
              27876.165619956704
            ],
            [
              1697855423370,
              27864.902785988445
            ],
            [
              1697855704603,
              27854.487134235074
            ],
            [
              1697856025049,
              27825.88969446551
            ],
            [
              1697856321170,
              27824.132512935295
            ],
            [
              1697856620275,
              27836.874430263153
            ],
            [
              1697856917936,
              27828.242190339733
            ],
            [
              1697857247054,
              27832.112712494523
            ],
            [
              1697857515526,
              27836.619351793917
            ],
            [
              1697857843451,
              27834.378170527154
            ],
            [
              1697858100095,
              27820.013720392002
            ],
            [
              1697858408037,
              27874.155498515036
            ],
            [
              1697858705405,
              27865.403840885814
            ],
            [
              1697859035680,
              27884.982889674775
            ],
            [
              1697859313812,
              27918.594024311074
            ],
            [
              1697859645863,
              27944.124001392494
            ],
            [
              1697859924668,
              27932.55911961973
            ],
            [
              1697860241610,
              27947.11684399799
            ],
            [
              1697860500684,
              27957.938735215655
            ],
            [
              1697860819260,
              27947.226088808457
            ],
            [
              1697861096399,
              27947.09684074888
            ],
            [
              1697861395494,
              27962.824047859882
            ],
            [
              1697861715677,
              27968.44410552172
            ],
            [
              1697862004103,
              27943.063378747287
            ],
            [
              1697862292455,
              27946.828517284768
            ],
            [
              1697862613417,
              27926.724499429296
            ],
            [
              1697862910736,
              27934.112185716654
            ],
            [
              1697863210469,
              27931.082651984736
            ],
            [
              1697863520615,
              27910.690592030758
            ],
            [
              1697863806187,
              27936.110528301135
            ],
            [
              1697864116817,
              27919.5875199295
            ],
            [
              1697864402770,
              27898.09498854559
            ],
            [
              1697864718594,
              27886.194363726132
            ],
            [
              1697865025798,
              27906.379026552444
            ],
            [
              1697865321750,
              27905.540973233285
            ],
            [
              1697865618878,
              27903.688755779225
            ],
            [
              1697865916714,
              27905.95667042273
            ],
            [
              1697866229770,
              27918.701591740544
            ],
            [
              1697866514892,
              27915.467319176118
            ],
            [
              1697866792712,
              27913.850766124997
            ],
            [
              1697867099756,
              27921.129735520208
            ],
            [
              1697867420963,
              27924.42842977574
            ],
            [
              1697867719650,
              27892.60027012774
            ],
            [
              1697868027280,
              27899.6651255155
            ],
            [
              1697868329012,
              27930.780590978873
            ],
            [
              1697868640637,
              27923.547079042895
            ],
            [
              1697868927677,
              27937.227737903264
            ],
            [
              1697869255152,
              27952.431105963464
            ],
            [
              1697869500630,
              27933.091384517556
            ],
            [
              1697869808817,
              27966.41134668454
            ],
            [
              1697870112228,
              28006.245320803566
            ],
            [
              1697870399571,
              28036.88431228878
            ],
            [
              1697870698558,
              28030.352969361582
            ],
            [
              1697870996299,
              28033.667118861096
            ],
            [
              1697871296237,
              28040.8897724233
            ],
            [
              1697871596214,
              28036.430004967537
            ],
            [
              1697871911617,
              28011.20395208574
            ],
            [
              1697872229925,
              27996.382767726405
            ],
            [
              1697872515402,
              27998.092099498735
            ],
            [
              1697872812774,
              28011.1134163547
            ],
            [
              1697873109811,
              28016.039361824893
            ],
            [
              1697873417788,
              28062.200703770668
            ],
            [
              1697873714730,
              28045.786851289104
            ],
            [
              1697874036637,
              28039.64781254542
            ],
            [
              1697874312281,
              28039.4304905456
            ],
            [
              1697874609607,
              28039.5092979569
            ],
            [
              1697874909306,
              28032.532811899317
            ],
            [
              1697875257423,
              28028.457505443424
            ],
            [
              1697875527233,
              28026.514597185702
            ],
            [
              1697875794690,
              28003.794500300704
            ],
            [
              1697876117743,
              27989.353900686572
            ],
            [
              1697876438357,
              28002.981437017468
            ],
            [
              1697876714139,
              28015.38073760193
            ],
            [
              1697877025496,
              28038.68084030884
            ],
            [
              1697877323168,
              28044.45763221235
            ],
            [
              1697877601058,
              28029.510232160075
            ],
            [
              1697877907762,
              28010.581022108963
            ],
            [
              1697878207305,
              28018.527392907392
            ],
            [
              1697878504811,
              28000.062041922025
            ],
            [
              1697878824840,
              27998.457668287097
            ],
            [
              1697879098645,
              27990.93616019485
            ],
            [
              1697879405850,
              27990.18978514913
            ],
            [
              1697879715008,
              27991.324199384882
            ],
            [
              1697880033946,
              27993.349346304858
            ],
            [
              1697880302760,
              28005.868807361727
            ],
            [
              1697880613036,
              28023.73821689595
            ],
            [
              1697880917601,
              28024.967757333223
            ],
            [
              1697881245956,
              28023.786162646007
            ],
            [
              1697881531368,
              28061.501626311747
            ],
            [
              1697881838934,
              28092.43028075335
            ],
            [
              1697882137234,
              28107.512994435416
            ],
            [
              1697882394275,
              28172.57389380719
            ],
            [
              1697882692662,
              28156.543610768556
            ],
            [
              1697883001694,
              28122.38036171669
            ],
            [
              1697883303066,
              28104.635022530132
            ],
            [
              1697883603498,
              28131.969601205525
            ],
            [
              1697883900721,
              28145.978480661128
            ],
            [
              1697884201451,
              28105.61217615462
            ],
            [
              1697884499236,
              28111.76528463188
            ],
            [
              1697884795203,
              28089.443851474567
            ],
            [
              1697885115663,
              28083.996259941458
            ],
            [
              1697885406420,
              28112.986475868576
            ],
            [
              1697885696614,
              28139.16308258945
            ],
            [
              1697885993812,
              28120.676888002876
            ],
            [
              1697886294384,
              28089.19724756786
            ],
            [
              1697886601630,
              28119.990945806527
            ],
            [
              1697886911889,
              28122.210416170154
            ],
            [
              1697887211693,
              28151.279551594427
            ],
            [
              1697887521159,
              28124.96991961432
            ],
            [
              1697887843523,
              28168.74479584871
            ],
            [
              1697888121736,
              28142.766538641084
            ],
            [
              1697888404755,
              28116.61992926428
            ],
            [
              1697888700914,
              28110.930700035984
            ],
            [
              1697889001986,
              28153.384464656436
            ],
            [
              1697889321005,
              28134.33841373431
            ],
            [
              1697889654747,
              28118.985427677377
            ],
            [
              1697889899885,
              28127.11764723108
            ],
            [
              1697890199006,
              28104.648851345803
            ],
            [
              1697890516865,
              28093.948539202767
            ],
            [
              1697890860212,
              28080.66202965506
            ],
            [
              1697891128212,
              28088.52166031933
            ],
            [
              1697891459535,
              28099.93577808515
            ],
            [
              1697891726333,
              28107.69072252604
            ],
            [
              1697892002498,
              28117.608796520053
            ],
            [
              1697892319054,
              28134.604603854565
            ],
            [
              1697892595470,
              28167.247197072866
            ],
            [
              1697892903636,
              28116.981601880507
            ],
            [
              1697893201644,
              28108.632686375255
            ],
            [
              1697893499662,
              28102.96267539589
            ],
            [
              1697893797481,
              28103.60727875568
            ],
            [
              1697894115755,
              28043.48024519181
            ],
            [
              1697894427272,
              28058.50734572134
            ],
            [
              1697894728547,
              28060.501406197804
            ],
            [
              1697895026545,
              28069.708169829202
            ],
            [
              1697895326849,
              28074.69716220312
            ],
            [
              1697895635428,
              28077.819798114302
            ],
            [
              1697895923707,
              28085.154476519794
            ],
            [
              1697896210010,
              28090.97718806798
            ],
            [
              1697896519630,
              28122.563233128745
            ],
            [
              1697896822710,
              28101.021148018965
            ],
            [
              1697897113795,
              28086.528524234327
            ],
            [
              1697897409528,
              28113.039613018405
            ],
            [
              1697897717397,
              28114.086945136987
            ],
            [
              1697898027246,
              28134.398029145028
            ],
            [
              1697898313329,
              28109.69862387906
            ],
            [
              1697898612086,
              28120.50851446115
            ],
            [
              1697898900670,
              28107.887792728936
            ],
            [
              1697899228946,
              28130.868980957344
            ],
            [
              1697899519979,
              28147.86521656452
            ],
            [
              1697899817691,
              28198.41095393396
            ],
            [
              1697900013000,
              28216.452946992125
            ]
          ],
        weekGraph: []
    )
}
